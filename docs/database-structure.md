# Database Structure Documentation

**Project:** Trabajo Práctico 1 - Análisis de Datos con Métodos Data-Driven
**Data Source:** Brazilian Traffic Accidents (DATATRAN, 2007-2025)
**Last Updated:** 2025-11-28

---

## Overview

This project uses SQLite databases to store traffic accident data at different processing stages:

1. **Raw Database** (`data/datatran_raw.db`) - Original data from CSV files
2. **Analysis Database** (`extracted/analysis_data.db`) - Processed data for analysis

For usage examples and code snippets, see `database-usage-examples.md`.

---

## Database Files

### 1. Raw Database

**Location:** `data/datatran_raw.db`
**Size:** ~500 MB (varies)
**Purpose:** Store unprocessed accident records from 2007-2025
**Source:** Generated by `make create-sqlite` from downloaded CSV files
**Git Status:** ⛔ Ignored (not committed to repository)

### 2. Analysis Database

**Location:** `extracted/analysis_data.db`
**Size:** ~50 MB (varies)
**Purpose:** Store processed data ready for POD/DMD analysis
**Source:** Generated by `make extract-data`
**Git Status:** ✅ Committed (shared with team)

---

## Table Schemas

### Raw Database (`data/datatran_raw.db`)

#### Table: `accidents`

**Description:** Complete raw accident records from 2007-2025

**Row Count:** 2,181,797 records

**Schema:**

| Column | Type | Description | Example |
|--------|------|-------------|---------|
| `row_id` | INTEGER PRIMARY KEY | Auto-increment unique ID | 1, 2, 3... |
| `id` | INTEGER | Original accident ID (not unique across years) | 123456 |
| `data_inversa` | TEXT | Date in YYYYMMDD format | 20230115 |
| `dia_semana` | TEXT | Day of week (Portuguese) | segunda-feira, domingo |
| `horario` | TEXT | Time of accident | 14:30:00 |
| `uf` | TEXT | State code (Unidade Federativa) | SP, RJ, MG |
| `br` | INTEGER | Federal highway number | 101, 116, 381 |
| `km` | TEXT | Kilometer marker | 123.5 |
| `municipio` | TEXT | Municipality name | SAO PAULO, RIO DE JANEIRO |
| `causa_acidente` | TEXT | Accident cause | Falta de atenção, Velocidade incompatível |
| `tipo_acidente` | TEXT | Accident type | Colisão frontal, Atropelamento |
| `classificacao_acidente` | TEXT | Severity classification | Com Vítimas Fatais, Sem Vítimas |
| `fase_dia` | TEXT | Time of day phase | Pleno dia, Anoitecer, Plena noite |
| `sentido_via` | TEXT | Road direction | Crescente, Decrescente |
| `condicao_metereologica` | TEXT | Weather condition | Céu Claro, Chuva, Nublado |
| `tipo_pista` | TEXT | Road type | Dupla, Simples, Múltipla |
| `tracado_via` | TEXT | Road layout | Reta, Curva, Interseção |
| `uso_solo` | TEXT | Land use | Urbano, Rural |
| `ano` | INTEGER | Year | 2023, 2024 |
| `pessoas` | INTEGER | Total people involved | 3, 5, 1 |
| `mortos` | INTEGER | Fatalities | 0, 1, 2 |
| `feridos_leves` | INTEGER | Lightly injured | 0, 1, 2 |
| `feridos_graves` | INTEGER | Seriously injured | 0, 1, 2 |
| `ilesos` | INTEGER | Unharmed | 0, 1, 2 |
| `ignorados` | INTEGER | Unknown status | 0, 1 |
| `feridos` | INTEGER | Total injured (leves + graves) | 1, 2, 3 |
| `veiculos` | INTEGER | Number of vehicles | 1, 2, 3 |
| `latitude` | TEXT | Latitude coordinate | -23.5505 |
| `longitude` | TEXT | Longitude coordinate | -46.6333 |
| `regional` | TEXT | Regional office | REGIONAL SAO PAULO |
| `delegacia` | TEXT | Police station | DELEGACIA SP |
| `uop` | TEXT | Operational unit | UOP CENTRO |

**Important Notes:**
- **NULL values:** Stored as actual NULL (not string '(null)') after recent fix
- **Date format:** `data_inversa` uses YYYYMMDD (e.g., 20230115 = January 15, 2023)
- **Coordinates:** `latitude`/`longitude` only available for 2017-2025 data
- **Primary key:** `row_id` is unique across all records; `id` is NOT unique

---

### Analysis Database (`extracted/analysis_data.db`)

#### Table: `accidents_daily`

**Description:** Daily accident counts for time series analysis

**Row Count:** 6,879 records (one per day from 2007-01-01 to 2025-10-31)

**Schema:**

| Column | Type | Description | Example |
|--------|------|-------------|---------|
| `date` | TEXT | Date in ISO format (YYYY-MM-DD) | 2023-01-15 |
| `accidents_count` | INTEGER | Number of accidents on that day | 42 |

**Usage:** Time series analysis, trend detection, FFT analysis

**Date Range:** 2007-01-01 to 2025-12-31 (complete coverage)

---

#### Table: `accidents_spatial`

**Description:** Spatial accident data with coordinates (2017-2025 only)

**Row Count:** 619,597 records (only accidents with coordinates from 2017-2025)

**Schema:**

| Column | Type | Description | Example |
|--------|------|-------------|---------|
| `date` | TEXT | Date in ISO format (YYYY-MM-DD) | 2023-01-15 |
| `uf` | TEXT | State code | SP, RJ, MG |
| `municipio` | TEXT | Municipality name | SAO PAULO |
| `latitude` | REAL | Latitude coordinate (normalized) | -23.5505 |
| `longitude` | REAL | Longitude coordinate (normalized) | -46.6333 |

**Important Notes:**
- **Coordinates:** Cleaned and normalized (comma → period, invalid removed)
- **Missing UF:** Filled based on municipality mapping where possible
- **Date range:** Only 2017-2025 (years with coordinate data)
- **NULL handling:** Records with NULL coordinates are excluded

**Usage:** POD/DMD spatio-temporal analysis, geographic visualization

**Geographic Coverage:** All Brazilian states with federal highways

**Coordinate Ranges:**
- Latitude: -33.71° to 4.48° (South to North Brazil)
- Longitude: -72.66° to -32.41° (West to East Brazil)

**Data Quality Note:** 33 records have invalid coordinates outside valid lat/lon ranges and should be filtered for analysis.

---

## Data Processing Pipeline

### Step 1: Download Raw Data

```bash
make download
```

**Input:** Google Drive file IDs from `etl/enlaces.csv`
**Output:** CSV files in `data/datatran*.csv` (one per year, 2007-2025)

### Step 2: Create Raw Database

```bash
make create-sqlite
```

**Process:**
1. Reads all CSV files from `data/`
2. Normalizes NULL values ('(null)' → NULL)
3. Creates unified schema (31 columns)
4. Imports all records with auto-increment primary key
5. Deletes CSV files after import (configurable via `DELETE_CSV_AFTER_IMPORT`)

**Input:** CSV files in `data/`
**Output:** `data/datatran_raw.db` with `accidents` table

### Step 3: Extract Analysis Data

```bash
make extract-data
```

**Process:**
1. Extracts time series data:
   - Normalizes dates from three different formats
   - Groups by date and counts accidents
   - Creates `accidents_daily` table

2. Extracts spatial data:
   - Filters records with coordinates (2017-2025)
   - Cleans coordinate format (comma → period)
   - Converts to REAL type
   - Fills missing UF values using municipality mapping
   - Removes invalid coordinates
   - Creates `accidents_spatial` table

**Input:** `data/datatran_raw.db`
**Output:** `extracted/analysis_data.db` with both tables

---

## Data Quality Notes

### Date Handling

**Raw database (`data_inversa`):**
- Format: YYYYMMDD (text)
- Example: `20230115` = January 15, 2023
- Three different formats exist in source data (handled during extraction)

**Analysis database (`date`):**
- Format: YYYY-MM-DD (ISO 8601)
- Example: `2023-01-15`
- Standardized format across all tables
- SQLite stores as TEXT (no native DATE type)

### Coordinate Data

**Availability by year:**
- ❌ 2007-2016: No coordinates available
- ✅ 2017-2025: Coordinates available (9 years of spatial data)

**Data cleaning applied:**
- Original format: Mixed decimal separators (`.` and `,`)
- Normalization: All commas converted to periods
- Type conversion: TEXT → REAL (float)
- Validation: Invalid coordinates identified (33 records with invalid ranges)
- Coverage: 619,597 coordinate records total, 619,544 within valid Brazil bounds

**Common issues handled:**
- Decimal separator inconsistency
- NULL values stored as text '(null)'
- Missing UF values (filled using municipality mapping)
- Out-of-range coordinates (removed)

### NULL Values

**Before fix (2025-11-27):**
- Stored as string `'(null)'` in many fields
- Wasted storage space (~7 bytes per field)
- Required checking both `IS NULL` and `= '(null)'`

**After fix (2025-11-28):**
- Proper SQL NULL values
- Smaller database size
- Standard SQL semantics
- Cleaner queries

**Fields most affected by NULL values:**
- `latitude`, `longitude` (NULL in 2007-2016)
- `uf` (occasionally NULL, filled when possible)
- `regional`, `delegacia`, `uop` (frequently NULL)

### Data Completeness

**Complete fields (all years):**
- `date` (formerly `data_inversa`)
- `dia_semana`, `horario`
- `uf`, `municipio` (with some NULLs)
- `pessoas`, `mortos`, `feridos`, `veiculos`
- `tipo_acidente`, `classificacao_acidente`

**Partial fields:**
- `latitude`, `longitude` (only 2017-2025)
- `causa_acidente` (many NULLs)
- `regional`, `delegacia`, `uop` (many NULLs)

**Actual record counts:**
- Total accidents (2007-2025): 2,181,797
- With coordinates (2017-2025): 619,597
- Daily records: 6,879 days

---

## Data Statistics

### Temporal Coverage

**Full dataset:**
- Start: 2007-01-01
- End: 2025-10-31
- Duration: 18 years, 10 months
- Days: 6,879

**Spatial dataset:**
- Start: 2017-01-01
- End: 2025-10-31
- Duration: 8 years, 10 months

### Geographic Coverage

**States (UF) covered:** 27 Brazilian states
**Municipalities:** 2,142 unique municipalities
**Primary coverage:** Federal highways (BR-xxx)

**Top states by accident count (2017-2025 spatial data):**
1. MG (Minas Gerais) - 81,672
2. SC (Santa Catarina) - 73,191
3. PR (Paraná) - 69,251
4. RJ (Rio de Janeiro) - 45,830
5. RS (Rio Grande do Sul) - 43,273
6. SP (São Paulo) - 41,115
7. BA (Bahia) - 33,281
8. GO (Goiás) - 29,769
9. PE (Pernambuco) - 25,398
10. ES (Espírito Santo) - 22,652

### Temporal Patterns

**Expected patterns in data:**
- **Seasonality:** Higher accidents in December-January (vacation season)
- **Weekly:** Higher on weekends (Friday-Sunday)
- **COVID impact:** Drop in 2020-2021
- **Trend:** Generally increasing with population/vehicle growth

### Accident Volume

**Maximum accidents per month:** 18,929 (December 2010, from daily data)
**Maximum in spatial data:** 8,624 (December 2017, only includes records with coordinates)
**Average accidents per day:** 317
**Average accidents per month:** 9,654

---

## Database Maintenance

### Rebuilding Databases

**If you need to rebuild from scratch:**

```bash
# Download data again (if CSVs deleted)
make download

# Rebuild raw database
make create-sqlite

# Rebuild analysis database
make extract-data
```

**When to rebuild:**
- Data corruption
- Schema changes
- Source data updated
- NULL handling fix applied

### Backup

**Raw database** (`data/datatran_raw.db`):
- Not backed up in git (too large)
- Can be regenerated from CSVs
- CSVs can be re-downloaded from Google Drive

**Analysis database** (`extracted/analysis_data.db`):
- ✅ Committed to git repository
- Shared with team
- Should be backed up before modifications

### Storage Requirements

**Disk space needed:**
- CSV files: ~1 GB (deleted after import by default)
- Raw database: 441 MB
- Analysis database: 31 MB
- **Total (after pipeline):** ~472 MB

---

## Configuration

### ETL Configuration

**File:** `etl/create_sqlite_db.py`

```python
DELETE_CSV_AFTER_IMPORT = True  # Delete CSVs after successful import
```

**Options:**
- `True`: Save disk space (CSVs can be re-downloaded)
- `False`: Keep CSVs for reference (requires ~1GB extra)

### Database Locations

**Can be changed in respective ETL scripts:**
- Raw: `etl/create_sqlite_db.py` → `DB_FILENAME`
- Analysis: `etl/extract_*.py` → `TARGET_DB`

**Current paths:**
- Raw: `data/datatran_raw.db`
- Analysis: `extracted/analysis_data.db`

---

## Quick Reference

### Common Commands

```bash
# Full pipeline (from scratch)
make download
make create-sqlite
make extract-data

# Rebuild only analysis database
make extract-data

# Open analysis database
sqlite3 extracted/analysis_data.db

# Check table sizes
sqlite3 extracted/analysis_data.db "SELECT COUNT(*) FROM accidents_daily;"
sqlite3 extracted/analysis_data.db "SELECT COUNT(*) FROM accidents_spatial;"
```

### Table Summary

| Table | Database | Rows | Columns | Purpose |
|-------|----------|------|---------|---------|
| `accidents` | Raw | 2,181,797 | 31 | Complete raw data |
| `accidents_daily` | Analysis | 6,879 | 3 | Time series |
| `accidents_spatial` | Analysis | 619,597 | 5 | Spatio-temporal |

### Field Quick Reference

**Key fields for analysis:**
- **Temporal:** `date` (ISO format, TEXT)
- **Spatial:** `latitude`, `longitude` (REAL)
- **Administrative:** `uf`, `municipio` (TEXT)
- **Metrics:** `accidents_count` (daily table), or COUNT(*) (spatial table)

---

## Related Documentation

- **Usage Examples:** `docs/database-usage-examples.md` - Python, R, SQL examples
- **Implementation Guide:** `docs_local/pod-dmd-implementation-guide.md` - Analysis methods
- **Project README:** `README.md` - Overall project structure

---

## Change Log

**2025-11-28:**
- NULL value normalization ('(null)' → NULL)
- Documentation split (structure vs examples)

**2025-11-27:**
- Initial database structure
- Coordinate cleaning implementation
- UF filling logic

**Contact:** See project repository for team contacts and updates
